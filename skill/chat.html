<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SkillShareboard Chat</title>
<link rel="stylesheet" href="css/style.css">
<style>
body, html { margin:0; padding:0; height:100%; font-family:'Poppins',sans-serif; background: linear-gradient(120deg,#e0f7fa 0%,#f5f7fa 100%); }
/* Navbar matching previous style */
header.main-header { background: linear-gradient(90deg,#2575fc 60%,#4CAF50 100%); color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
header.main-header h1 { font-size:1.5rem; margin:0; }
header.main-header nav a { margin-left:16px; text-decoration:none; color:#fff; font-weight:500; }
header.main-header nav a:hover { text-decoration:underline; }

/* Split layout */
.chat-wrapper { display:flex; height:calc(100vh - 60px); overflow:hidden; }

/* Chat List */
.chat-list { width:300px; background:#f7fafc; border-right:1px solid #ddd; display:flex; flex-direction:column; }
.chat-list header { background: linear-gradient(90deg,#2575fc 60%,#4CAF50 100%); color:#fff; padding:16px; text-align:center; font-size:1.3rem; font-weight:600; }
#chat-list { flex:1; overflow-y:auto; padding:12px; }
.user-row { display:flex; align-items:center; background:#fff; margin-bottom:10px; padding:10px 12px; border-radius:12px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.05); transition:background 0.2s; }
.user-row:hover { background:#e5f1ff; }
.user-avatar { width:50px; height:50px; border-radius:50%; object-fit:cover; margin-right:12px; }
.user-info { flex:1; display:flex; flex-direction:column; }
.user-name { font-weight:600; color:#2575fc; font-size:1rem; }
.last-message { font-size:0.9rem; color:#555; margin-top:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.timestamp { font-size:0.75rem; color:#888; margin-left:8px; }

/* Chat Area */
.chat-area { flex:1; display:flex; flex-direction:column; justify-content:flex-end; background:#fff; border-radius:0 18px 18px 0; overflow:hidden; }
#chat-header {background: linear-gradient(90deg,#2575fc 60%,#4CAF50 100%); color:#fff; padding:18px 24px; text-align:center; font-size:1.2rem; font-weight:500; letter-spacing:1px; box-shadow:0 2px 8px rgba(37,117,252,0.08);}
#chat-box { flex:1; overflow-y:auto; padding:18px 12px; background:#f7fafc; border-bottom:1px solid #eee;}
#chat-input-bar {display:flex; flex-direction:column; gap:10px; align-items:stretch; padding:16px; background:#f9f9f9; border-top:1px solid #e0e0e0;}
#chat-message {flex:1; padding:12px 16px; border-radius:24px; border:1.5px solid #2575fc; font-size:1rem; background:#fff; margin-bottom:8px;}
#chat-input-bar button {background:linear-gradient(90deg,#2575fc 60%,#4CAF50 100%); color:#fff; border:none; border-radius:24px; padding:10px 28px; font-weight:600; font-size:1rem; cursor:pointer;}
#chat-input-bar button:hover {background: linear-gradient(90deg,#1dcc97 60%,#2575fc 100%);}
.bubble-row { display:flex; align-items:flex-end; margin-bottom:18px; position:relative;}
.bubble-row.me { justify-content:flex-end;}
.bubble-row.them { justify-content:flex-start;}
.chat-avatar { width:36px; height:36px; border-radius:50%; margin:0 10px; object-fit:cover;}
.chat-bubble { max-width:68%; padding:12px 18px; border-radius:20px; font-size:1rem; word-break:break-word; position:relative; display:flex; flex-direction:column; background:#e5e5ea; color:#222;}
.bubble-row.me .chat-bubble { background: linear-gradient(135deg, #f58529, #dd2a7b, #8134af, #515bd4); color: #fff; align-items: flex-end;}
.bubble-row.them .chat-bubble { background:#e5e5ea; color:#222; align-items:flex-start;}
.bubble-time { font-size:0.8em; color:#888; margin-top:6px; text-align:right;}
.bubble-name { font-size:0.9em; font-weight:500; color:#2575fc; margin-bottom:2px; text-align:left;}
.unsend-btn { background:transparent; border:none; color:#888; font-size:1.2em; cursor:pointer; margin-left:auto; }

/* Toast */
#toast-container { position: fixed; top:20px; right:20px; z-index:9999; }
.toast { background: rgba(37,117,252,0.95); color: #fff; padding: 10px 16px; margin-top:10px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.2);}
</style>
</head>
<body>

<header class="main-header">
  <h1>SkillShareboard</h1>
  <nav>
    <a href="dashboard.html">Home</a>
    <a href="profile.html">Profile</a>
    <a href="requests.html">Requests</a>
    <a href="post-service.html">Post Service</a>
    <a href="#" onclick="logout()">Logout</a>
  </nav>
</header>

<div class="chat-wrapper">
  <!-- Chat List -->
  <div class="chat-list">
    <header>Chats</header>
    <div id="chat-list"></div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div id="chat-header">Select a user</div>
    <div id="chat-box"></div>
    <div id="chat-input-bar">
      <input type="text" id="chat-message" placeholder="Type a message..." disabled>
      <button type="button" disabled>Send</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script type="module">
import { supabase } from './js/supabase.js';
import { getCurrentUser } from './js/auth.js';

const chatListEl = document.getElementById('chat-list');
const chatBox = document.getElementById('chat-box');
const messageInput = document.querySelector('#chat-message');
const sendBtn = document.querySelector('#chat-input-bar button');

let currentUser = null;
let activeChat = null;
let recipientInfo = {};

function showToast(msg) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

async function loadCurrentUser() {
  currentUser = await getCurrentUser();
  if (!currentUser) {
    showToast("Login required.");
    setTimeout(()=>window.location.href="login.html", 1500);
  }
}

async function getChatUsers() {
  const { data, error } = await supabase
    .from('messages')
    .select('sender_id, recipient_id, content, created_at')
    .or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
    .order('created_at', { ascending: false });
  if (error) { showToast(error.message); return []; }

  const userMap = {};
  data.forEach(msg => {
    const otherId = msg.sender_id === currentUser.id ? msg.recipient_id : msg.sender_id;
    if (!userMap[otherId]) userMap[otherId] = msg;
  });

  const userIds = Object.keys(userMap);
  if (!userIds.length) return [];

  const { data: users, error: userError } = await supabase
    .from('users')
    .select('id,name,profile_pic')
    .in('id', userIds);
  if (userError) { showToast(userError.message); return []; }

  return users.map(u => ({ ...u, lastMessage:userMap[u.id].content, lastTime:userMap[u.id].created_at }));
}

function renderUserRow(user) {
  const row = document.createElement('div');
  row.className = 'user-row';
  row.innerHTML = `
    <img class="user-avatar" src="${user.profile_pic || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=2575fc&color=fff&size=64`}" alt="${user.name}">
    <div class="user-info">
      <div class="user-name">${user.name}</div>
      <div class="last-message">${user.lastMessage}</div>
    </div>
    <div class="timestamp">${new Date(user.lastTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
  `;
  row.addEventListener('click', () => selectChat(user));
  chatListEl.appendChild(row);
}

async function selectChat(user) {
  activeChat = user.id;
  recipientInfo = user;
  document.getElementById('chat-header').textContent = `Chat with ${user.name}`;
  messageInput.disabled = false;
  sendBtn.disabled = false;
  chatBox.innerHTML = '';
  loadMessages();
}

async function loadMessages() {
  if (!activeChat) return;
  const { data, error } = await supabase
    .from('messages')
    .select('id, sender_id, recipient_id, content, created_at')
    .or(`and(sender_id.eq.${currentUser.id},recipient_id.eq.${activeChat}),and(sender_id.eq.${activeChat},recipient_id.eq.${currentUser.id})`)
    .order('created_at', { ascending: true });
  if (error) { showToast(error.message); return; }

  chatBox.innerHTML = '';
  data.forEach(msg => renderMessage(msg));
  chatBox.scrollTop = chatBox.scrollHeight;
}

function renderMessage(msg) {
  const isMe = msg.sender_id === currentUser.id;
  const row = document.createElement('div');
  row.className = 'bubble-row ' + (isMe ? 'me' : 'them');

  const avatarUrl = isMe
    ? currentUser.profile_pic || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=2575fc&color=fff&size=64`
    : recipientInfo.profile_pic || `https://ui-avatars.com/api/?name=${encodeURIComponent(recipientInfo.name)}&background=81d421&color=fff&size=64`;

  const unsendBtn = isMe ? `<button class="unsend-btn">â‹®</button>` : '';
  row.innerHTML = `
    ${!isMe ? `<img class="chat-avatar" src="${avatarUrl}" alt="User">` : ""}
    <div class="chat-bubble">
      ${!isMe ? `<div class="bubble-name">${recipientInfo.name}</div>` : ""}
      ${msg.content}
      ${unsendBtn}
      <div class="bubble-time">${new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
    </div>
    ${isMe ? `<img class="chat-avatar" src="${avatarUrl}" alt="Me">` : ""}
  `;
  chatBox.appendChild(row);

  if (isMe) {
    const btn = row.querySelector('.unsend-btn');
    btn.addEventListener('click', () => {
      showToast("Deleting...");
      supabase.from('messages').delete().eq('id', msg.id).then(({ error }) => {
        if (error) showToast(error.message);
        else { row.remove(); showToast("Message deleted."); }
      });
    });
  }
}

sendBtn.addEventListener('click', async () => {
  const content = messageInput.value.trim();
  if (!content || !activeChat) return;
  const newMessage = { sender_id: currentUser.id, recipient_id:activeChat, content, created_at:new Date().toISOString() };
  renderMessage(newMessage);
  messageInput.value = '';
  const { error } = await supabase.from('messages').insert([newMessage]);
  if (error) showToast(error.message);
  chatBox.scrollTop = chatBox.scrollHeight;
});

window.addEventListener('DOMContentLoaded', async () => {
  await loadCurrentUser();
  const users = await getChatUsers();
  if (!users.length) chatListEl.textContent = "No chats yet.";
  users.forEach(u => renderUserRow(u));
  setInterval(() => { if(activeChat) loadMessages(); }, 3000);
});
</script>

</body>
</html>

